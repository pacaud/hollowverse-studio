<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inkpad — Data workspace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="app-body">
  <header class="top-bar">
    <div class="top-bar-inner">
      <button class="ghost-btn" onclick="goHome()">← Back</button>
      <h1 class="top-title">Inkpad</h1>
      <span class="top-subtitle">Listing contents of <code>data/</code></span>
    </div>
  </header>

  <main class="page">
    <section class="panel">
      <div class="panel-header">
        <h2>Data workspace</h2>
        <div class="panel-actions">
          <button class="secondary-btn" id="uploadBtn">
            Upload file
          </button>
          <button class="secondary-btn" onclick="loadFiles()" id="reloadBtn">
            Reload
          </button>
        </div>
      </div>

      <!-- Hidden file input for uploads -->
      <input type="file" id="fileInput" style="display:none" />

      <div id="status" class="status-line"></div>

      <ul id="fileList" class="file-list">
        <!-- populated by JS -->
      </ul>
    </section>
  </main>

<script>
  const API_BASE = "https://dataflow.hollowverse.studio";
  const API_KEY  = "uG2j48nRz7!mA@pF9xQvT1yCwK5oS"; // keep in sync with VOXIA_DATAFLOW_TOKEN
  const LIST_ENDPOINT     = API_BASE + "/dataflow/data/list";
  const UPLOAD_ENDPOINT   = API_BASE + "/dataflow/post";
  const DOWNLOAD_BASE_URL = API_BASE + "/dataflow/get/";

  function goHome() {
    window.location.href = "index.html";
  }

  // ---- List files ----
  async function loadFiles() {
    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("fileList");
    const reloadBtn = document.getElementById("reloadBtn");

    statusEl.textContent = "Loading files…";
    statusEl.className = "status-line status-info";
    listEl.innerHTML = "";
    reloadBtn.disabled = true;

    try {
      const res = await fetch(LIST_ENDPOINT, {
        method: "GET",
        headers: {
          "Accept": "application/json",
          "X-API-Key": API_KEY
        }
      });

      if (!res.ok) {
        throw new Error(`Error ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();
      const files = Array.isArray(data.files) ? data.files : [];

      if (files.length === 0) {
        statusEl.textContent = "No files found in data/.";
        statusEl.className = "status-line status-info";
        return;
      }

      files.forEach((file) => {
        const li = document.createElement("li");
        li.className = "file-item";

        const nameSpan = document.createElement("span");
        nameSpan.className = "file-name";
        nameSpan.textContent = file;

        const dlBtn = document.createElement("button");
        dlBtn.type = "button";
        dlBtn.className = "secondary-btn file-download-btn";
        dlBtn.textContent = "Download";
        dlBtn.addEventListener("click", () => downloadFile(file));

        li.appendChild(nameSpan);
        li.appendChild(dlBtn);
        listEl.appendChild(li);
      });

      statusEl.textContent = `Loaded ${files.length} file(s).`;
      statusEl.className = "status-line status-success";
    } catch (err) {
      console.error(err);
      statusEl.textContent = err.message || "Failed to load files.";
      statusEl.className = "status-line status-error";
    } finally {
      reloadBtn.disabled = false;
    }
  }

  // ---- Upload files ----
  async function uploadFile(file) {
    const statusEl  = document.getElementById("status");
    const uploadBtn = document.getElementById("uploadBtn");
    const reloadBtn = document.getElementById("reloadBtn");

    if (!file) {
      return;
    }

    const formData = new FormData();
    formData.append("file", file);

    statusEl.textContent = `Uploading “${file.name}”…`;
    statusEl.className = "status-line status-info";
    uploadBtn.disabled = true;
    reloadBtn.disabled = true;

    try {
      const res = await fetch(UPLOAD_ENDPOINT, {
        method: "POST",
        headers: {
          "X-API-Key": API_KEY
          // Don't set Content-Type manually; browser will handle it for FormData
        },
        body: formData
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Upload failed (${res.status}): ${text || res.statusText}`);
      }

      const data = await res.json().catch(() => ({}));
      const message = data.message || `Uploaded “${file.name}”.`;

      statusEl.textContent = message;
      statusEl.className = "status-line status-success";

      // Refresh list so the new file shows up
      await loadFiles();
    } catch (err) {
      console.error(err);
      statusEl.textContent = err.message || "Upload failed.";
      statusEl.className = "status-line status-error";
    } finally {
      uploadBtn.disabled = false;
      reloadBtn.disabled = false;
      const fileInput = document.getElementById("fileInput");
      if (fileInput) fileInput.value = "";
    }
  }

  // ---- Download files ----
  async function downloadFile(filename) {
    const statusEl = document.getElementById("status");

    statusEl.textContent = `Downloading “${filename}”…`;
    statusEl.className = "status-line status-info";

    try {
      const res = await fetch(DOWNLOAD_BASE_URL + encodeURIComponent(filename), {
        method: "GET",
        headers: {
          "X-API-Key": API_KEY
        }
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Download failed (${res.status}): ${text || res.statusText}`);
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      statusEl.textContent = `Downloaded “${filename}”.`;
      statusEl.className = "status-line status-success";
    } catch (err) {
      console.error(err);
      statusEl.textContent = err.message || "Download failed.";
      statusEl.className = "status-line status-error";
    }
  }

  // ---- Wire up buttons on load ----
  function setupInkpad() {
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");

    uploadBtn.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      uploadFile(file);
    });

    // Initial list
    loadFiles();
  }

  window.addEventListener("DOMContentLoaded", setupInkpad);
</script>

</body>
</html>
